services:
  wireguard-server:
    profiles: ["server"]
    build:
      context: ./wireguard
      dockerfile: Dockerfile
    container_name: wireguard-server
    cap_add:
      - NET_ADMIN
    ports:
      - "51821:51821/udp"
      - "3128:3128"
    environment:
      - ALLOWEDIPS=${ALLOWEDIPS}
      - PEERS=0
      - PROFILE=server
      - PUID=1000
      - PGID=1000
      - INTERNAL_SUBNET=10.0.2.1
      - LOG_CONFS=true
    env_file:
      - ./.env
    volumes:
      - ./wireguard/keys:/config/server
    entrypoint: ["/bin/bash"]
    command: ["/config/wireguard-entrypoint.sh"]
  wireguard-client:
    profiles: ["client"]
    build:
      context: ./wireguard
      dockerfile: Dockerfile
    container_name: wireguard-client
    ports:
      - "3128:3128"
    cap_add:
      - NET_ADMIN
    environment:
      - PROFILE=client
      - CLIENT_IP=${CLIENT_IP}
      - CLIENT_DNS=${CLIENT_DNS}
      - CLIENT_ENDPOINT=${CLIENT_ENDPOINT}
      - CLIENT_PORT=${CLIENT_PORT}
      - SERVER_PUBLIC_KEY=${SERVER_PUBLIC_KEY}
      - ALLOWEDIPS=${ALLOWEDIPS}
      - HOST_PUBLIC_IP=${HOST_PUBLIC_IP}
      - PUID=1000
      - PGID=1000
      - INTERNAL_SUBNET=10.0.2.1
      - LOG_CONFS=true
    env_file:
      - ./.env
    sysctls:
      - net.ipv4.conf.all.src_valid_mark=1
    volumes:
      - ./wireguard/keys:/config/server
    networks:
      - wireguard-network
    depends_on:
      minio:
        condition: service_healthy
    entrypoint: ["/bin/bash"]
    command: ["/config/wireguard-entrypoint.sh"]
  minio:
    profiles: ["client"]
    image: minio/minio:latest
    container_name: minio
    ports:
      - "${MINIO_WEB_PORT:-8080}:${MINIO_WEB_PORT:-8080}"
      - "${MINIO_CONSOLE_PORT:-4020}:${MINIO_CONSOLE_PORT:-4020}"
    environment:
      - MINIO_ROOT_USER=${MINIO_ROOT_USER:-admin}
      - MINIO_ROOT_PASSWORD=${MINIO_ROOT_PASSWORD:-miniopassword}
      - MINIO_ADDRESS=:${MINIO_WEB_PORT:-8080}
      - MINIO_CONSOLE_ADDRESS=:${MINIO_CONSOLE_PORT:-4020}
    env_file:
      - ./.env
    volumes:
      - minio-data:/data
    networks:
      - wireguard-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:${MINIO_WEB_PORT:-8080}/minio/health/live"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    command: server /data

networks:
  wireguard-network:
    driver: bridge

volumes:
  minio-data: